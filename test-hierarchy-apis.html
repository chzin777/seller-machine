<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - APIs de Hierarquia</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 3px; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; max-height: 300px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Teste - APIs de Hierarquia</h1>
        
        <div class="section info">
            <h3>üìã Status de Autentica√ß√£o</h3>
            <button onclick="checkAuth()">Verificar Autentica√ß√£o</button>
            <div id="authStatus"></div>
        </div>

        <div class="grid">
            <div class="section">
                <h3>üè¢ Empresas</h3>
                <button onclick="testAPI('/api/hierarchy/empresas', 'empresasResult')">Testar Empresas</button>
                <div id="empresasResult"></div>
            </div>

            <div class="section">
                <h3>üèõÔ∏è Diretorias</h3>
                <button onclick="testAPI('/api/hierarchy/diretorias', 'diretoriasResult')">Testar Diretorias</button>
                <button onclick="testAPIWithParam('/api/hierarchy/diretorias?empresaId=1', 'diretoriasParamResult')">Com Empresa ID=1</button>
                <div id="diretoriasResult"></div>
                <div id="diretoriasParamResult"></div>
            </div>

            <div class="section">
                <h3>üåé Regionais</h3>
                <button onclick="testAPI('/api/hierarchy/regionais', 'regionaisResult')">Testar Regionais</button>
                <button onclick="testAPIWithParam('/api/hierarchy/regionais?diretoriaId=1', 'regionaisParamResult')">Com Diretoria ID=1</button>
                <div id="regionaisResult"></div>
                <div id="regionaisParamResult"></div>
            </div>

            <div class="section">
                <h3>üè™ Filiais</h3>
                <button onclick="testAPI('/api/hierarchy/filiais', 'filiaisResult')">Testar Filiais</button>
                <button onclick="testAPIWithParam('/api/hierarchy/filiais?regionalId=1', 'filiaisParamResult')">Com Regional ID=1</button>
                <div id="filiaisResult"></div>
                <div id="filiaisParamResult"></div>
            </div>
        </div>

        <div class="section">
            <h3>üîÑ Teste Completo da Hierarquia</h3>
            <button onclick="testFullHierarchy()">Testar Hierarquia Completa</button>
            <div id="fullHierarchyResult"></div>
        </div>
    </div>

    <script>
        function checkAuth() {
            const authStatus = document.getElementById('authStatus');
            
            // Verificar localStorage/sessionStorage
            const userData = localStorage.getItem('user') || sessionStorage.getItem('user');
            
            let html = '<h4>Status de Autentica√ß√£o:</h4>';
            if (userData) {
                try {
                    const parsed = JSON.parse(userData);
                    html += `<div class="success">‚úÖ Usu√°rio logado: ${parsed.user?.name || parsed.name || 'Nome n√£o encontrado'}</div>`;
                    html += `<pre>${JSON.stringify(parsed, null, 2)}</pre>`;
                } catch (e) {
                    html += `<div class="error">‚ùå Erro ao parsear userData: ${e.message}</div>`;
                }
            } else {
                html += '<div class="error">‚ùå Nenhum usu√°rio logado encontrado</div>';
            }
            
            authStatus.innerHTML = html;
        }

        async function testAPI(endpoint, resultId) {
            const resultDiv = document.getElementById(resultId);
            resultDiv.innerHTML = '<p>üîÑ Testando...</p>';
            
            try {
                const response = await fetch(endpoint, {
                    method: 'GET',
                    credentials: 'include', // Incluir cookies
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Sucesso (${response.status})</div>
                        <p><strong>Registros encontrados:</strong> ${Array.isArray(data) ? data.length : 'N/A'}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">‚ùå Erro (${response.status})</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">‚ùå Erro de conex√£o: ${error.message}</div>
                `;
            }
        }

        async function testAPIWithParam(endpoint, resultId) {
            await testAPI(endpoint, resultId);
        }

        async function testFullHierarchy() {
            const resultDiv = document.getElementById('fullHierarchyResult');
            resultDiv.innerHTML = '<p>üîÑ Testando hierarquia completa...</p>';
            
            let html = '<h4>Teste da Hierarquia Completa:</h4>';
            
            try {
                // 1. Buscar empresas
                const empresasRes = await fetch('/api/hierarchy/empresas', { credentials: 'include' });
                const empresas = await empresasRes.json();
                
                if (!empresasRes.ok) {
                    html += `<div class="error">‚ùå Erro ao buscar empresas: ${empresas.error}</div>`;
                    resultDiv.innerHTML = html;
                    return;
                }
                
                html += `<div class="success">‚úÖ Empresas: ${empresas.length} encontradas</div>`;
                
                if (empresas.length > 0) {
                    const empresaId = empresas[0].id;
                    
                    // 2. Buscar diretorias da primeira empresa
                    const diretoriasRes = await fetch(`/api/hierarchy/diretorias?empresaId=${empresaId}`, { credentials: 'include' });
                    const diretorias = await diretoriasRes.json();
                    
                    if (diretoriasRes.ok) {
                        html += `<div class="success">‚úÖ Diretorias da empresa ${empresas[0].razaoSocial}: ${diretorias.length} encontradas</div>`;
                        
                        if (diretorias.length > 0) {
                            const diretoriaId = diretorias[0].id;
                            
                            // 3. Buscar regionais da primeira diretoria
                            const regionaisRes = await fetch(`/api/hierarchy/regionais?diretoriaId=${diretoriaId}`, { credentials: 'include' });
                            const regionais = await regionaisRes.json();
                            
                            if (regionaisRes.ok) {
                                html += `<div class="success">‚úÖ Regionais da diretoria ${diretorias[0].nome}: ${regionais.length} encontradas</div>`;
                                
                                if (regionais.length > 0) {
                                    const regionalId = regionais[0].id;
                                    
                                    // 4. Buscar filiais da primeira regional
                                    const filiaisRes = await fetch(`/api/hierarchy/filiais?regionalId=${regionalId}`, { credentials: 'include' });
                                    const filiais = await filiaisRes.json();
                                    
                                    if (filiaisRes.ok) {
                                        html += `<div class="success">‚úÖ Filiais da regional ${regionais[0].nome}: ${filiais.length} encontradas</div>`;
                                        html += '<div class="info">üéâ Hierarquia completa funcionando!</div>';
                                    } else {
                                        html += `<div class="error">‚ùå Erro ao buscar filiais: ${filiais.error}</div>`;
                                    }
                                }
                            } else {
                                html += `<div class="error">‚ùå Erro ao buscar regionais: ${regionais.error}</div>`;
                            }
                        }
                    } else {
                        html += `<div class="error">‚ùå Erro ao buscar diretorias: ${diretorias.error}</div>`;
                    }
                }
                
            } catch (error) {
                html += `<div class="error">‚ùå Erro de conex√£o: ${error.message}</div>`;
            }
            
            resultDiv.innerHTML = html;
        }

        // Executar verifica√ß√£o de autentica√ß√£o automaticamente
        window.onload = function() {
            checkAuth();
        };
    </script>
</body>
</html>